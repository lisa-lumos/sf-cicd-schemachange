create schema lisa_test;

create table demo_db.lisa_test.charon (
  schema_id varchar(256),
  schema_data binary(4096)
);

insert into demo_db.lisa_test.charon values 
('3a1a9f42-e196-4b70-b5c6-1addad75e25c', '1F8B0800000000000003ED534D6BDB4010FD2B831A7A72EC1E0A05DD0ACDA1B4851E92530966B53BF24E22ED28BB2B9960FCDF3B2BF9631DB71043E92917216667DE7BF36666535C9129CAA2F7AE0CDA62AB4A1CD0C5B261E5962DB615FA60A90BCBBE332AA2598ECFC5ACB89AD2A5D6C6D8958BC54360773D05E7EC570BE3551DAF3F7C5A4CB1775213293628157F03873DB8C1A03D7591D849FA4D8A42489FB54507DF1CEB47F0A891060CA07681EFE80CB9152474D056B99520AEB1B2CC8F3090821BA7B9ED5490126720E33F64D7EC215A9C20C840D2FCDC25C95C3DA04ED23ACF1DFA48188A723375921CDCEC1343F422E2AC87DB0C75CFC2F5916C6D39E05E135835205428BDEE9DF1D8794C16C8BF4A3DDFDD7DFD327C9C17DB59913BA98CC15C8EF25E3D9FA9F991F53E5640E4A3964A0589B01B2386EA5AA4C47552830707DF03F71E4C25D014B10D19E5C1AA53CECF99E3E7A492EEF1A9278FE667E6F02F89362A21A4B2E5C8303BB8BE9B8E4830C5FDCBD19C17BE6A4829234D667422539CC301C9A6E9712E945CA20053D3E3382EDA89DED1538FB215325AAA09FDC95688416B4BDA4E1C999A0A1B76AB30F2BDBEB774A2A03A9266828C4F9FF08E8D4FAB79C2351728747D9B86A1B4E65E2EF47E3B7A7E24957749BF9CF4700DA794709B029ABDD474EC4C484E881F3B7E2993CE4583AC11252AD5E44B53AB26E0F6C561786C79B8F0347635507B6EFFEB79FC91F8ED44DE4EE41F9FC876FB1BA2F691D201080000'),
('9c2d2446-3d1d-4f88-bec3-fe95e78a1583', '1F8B0800000000000003658ECB0AC2400C457F65082E6BC1ED7C850B772292CEC436B6666A66AA94D27F7784427D2C7373EFE14CB0610F1606151B5D4337B48F9D0D520554CF525BA784893C1490C69E723354577229DF9EA253EE1307C9F141B9AE49C99B6A34E85C18246D3D25E4CE3C1B12836256ACE16816729951E83DBF39D8ED35F4A4892982BD6017A900A5FBC0190CF6082BE19CB54F05F41FFDE9E79D83C599255196FB936E25B8B65C57E537609EE717858D75AB20010000'),
('3fefcc71-41d7-46f6-b12d-23304bfdba99', '1F8B0800000000000003AD96CF6F9B3014C7FF15CBEBB149B6D324AE3BEDD41E3AED5045C8984770636C663F325551FFF73D03492903421AA41C88F37D9FF7D3E41DF99D4A79C42B67222F732844242B8FB600A76CF4D7BABD2F8584089D305E4854D6081D55A50787AB9392DFF3BBC698483962196D362FDE9A5573B8B66EB7499DC870F5F5FBA639FB4236A8500359FC68313F1FD8EF9343F6D475C87ED50ED949B926EB14BC74AA0C824F33F0B50C01D8E40524D2F7D2D992340A3C8F8E3C14E6C885797DC878F47C3CA93D3A657653113C82A3EC5923642A5DF3B7FBB3B9A98AA42ED925F346D8986F2FCB1B373C152842D8D3A9510794EEC866E7541B3281A44F2A84DA65A8F001066B756DB20DEA23FF0C4BACD520CC0C5AAB1CC2CDA8E450103C53CE636C44019F295B3B0AEF901E5D8BDBE167468F5DE6D640DC76628981EE02475A652AAD67755DEB71DCB6177C7CA09752A660F85A5E3B6A83E4C526EF323D6457D84469886BF122ADE9026F6D4D5DA551603FFCD8177EF114027481099B4486448C456A90140113970E327060E42D977184D8BB9A5DD570F5AE9DEA0FC4C5A6799C3AE3753A11124D90C39DD84128912A92CA7928C060EC5160E587EA0F942815882B735048AF8270E2ACD6F5A3D4D6D3C38CA0CEC336E5BF17EC785033BDFD47654FB9F28C3E9803DB1B2BF76B6B122B5C4AF275EB8F3C4B0782928D052E72C5DE71A397EBBAA91B01CEE8C388E5DB65CBB0E8841DAE50E6B1B3DB7CA37D244D55B3F3757FC884F610C00EFE54CA857F91E7B0E2B52BD376DAEE1FDDE98AA6280B0000');

create or replace table demo_db.lisa_test.schema_names (
  schema_id varchar(256) primary key, 
  schema_data binary(4096), 
  table_name varchar(300)
);

insert into demo_db.lisa_test.schema_names (
  select schema_id, schema_data, concat('Acheron_schema_', schema_id) 
  from demo_db.lisa_test.charon
);

create or replace procedure demo_db.lisa_test.create_tables_hitorical(source_table varchar, target_schema varchar)
returns string
language javascript
execute as caller
as
$$
    var result;
        
    try {
        var select_sql = 'select table_name from ' + SOURCE_TABLE;
        var stmt = snowflake.createStatement( {sqlText: select_sql} );
        var table_names = stmt.execute(); 
        var table_name_array = [];
        
        while (table_names.next()) {
            table_name_array.push( table_names.getColumnValue(1) );
        }

        for (var i = 0; i < table_name_array.length; i++) {
            var str = 'create table if not exists ' + TARGET_SCHEMA + '.' + '\"' + table_name_array[i] + '\"' + ' (json_data variant);';
            var statement = snowflake.createStatement({sqlText: str});
            var result_tmp = statement.execute();
        };
        result = 'Totally ' + table_name_array.length + ' table(s) created if not exist(s).';
    } catch (err) {
        result =  "Failed: Code: " + err.code + "\n  State: " + err.state;
        result += "\n  Message: " + err.message;
        result += "\nStack Trace:\n" + err.stackTraceTxt;  
    }
    return result;
$$;
call demo_db.lisa_test.create_tables_hitorical('demo_db.lisa_test.schema_names', 'demo_db.lisa_test');


